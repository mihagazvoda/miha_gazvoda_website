---
title: "Fooled by correlation"
description: |
  A short description of the post.
author:
  - name: Miha Gazvoda
    url: https://mihagazvoda.com
date: 05-29-2021
output:
  distill::distill_article:
    self_contained: false
---

Once upon a time I worked as a student data scientist for a start-up where we wanted to predict something about the person based on the measurement we did on them. In theory, these measurements (biomarkers) should correlate with the thing we wanted to predict but: 

> In theory, theory and practice are the same. In practice, they are not.

So we had more than 10 features per person and only about, let's say 50 persons. We often found correlations but then got dissapointed after additional measurements when it dissapeared. It was like a cat chasing its tail. I got to wonder, ok, strongly suspect, that we are getting correlations out of thin air. My plan was to do a simulation to check how probable is to get correlations as they were ours. I left the job before I got to do the simulation.

Until, a few days ago I came across the video by Nassim Nicholas Taleb, doing and explain exactly the thing I planned to do. You can watch it on [Youtube](https://www.youtube.com/watch?v=fb921ZrM6h0). 


* 10 plus features

```{r}
library(dplyr)
library(ggplot2)

tidyr::crossing(
  n = seq(5, 100, 5),
  k = 1:1000
) %>% 
  rowwise() %>% 
  mutate(r = cor(rnorm(n), rnorm(n))) %>% 
  # group_by(n) %>% 
  # summarise(sd_r = sd(r)) %>% 
  ggplot(aes(n , r, group = n)) +
  geom_violin()
```

```{r cache=TRUE}
df <- tidyr::crossing(
  n = c(5, 10, 20, 30, 50, 100, 1000),
  r_actual = seq(0, 0.95, by = 0.05),
  k = 1:100
) %>% 
  rowwise() %>% 
  mutate(
    x = list(rnorm(n)),
    y = list(faux::rnorm_pre(x, r = r_actual)),
    r_calc = cor(x, y)
  )
```

```{r}
df %>% 
    filter(r_actual == 0.9, n == 5) %>% 
    ggplot(aes(r_calc)) + 
    geom_histogram(binwidth = 0.1)
```

```{r}
tmp <- df %>% 
  group_by(n, r_actual, r_calc_rounded = plyr::round_any(r_calc, 0.1)) %>% 
  summarise(count = n()) %>% 
  mutate(p = count / sum(count)) %>% 
  ungroup() %>% 
  bind_rows(
      filter(., r_actual != 0) %>% 
      mutate(across(c(r_actual, r_calc_rounded), `-`))
  )
```

```{r}
tmp2 <- tmp %>% 
  group_by(n, r_calc_rounded) %>% 
  mutate(p_posterior = p / sum(p))
```

```{r}
tmp2 %>% 
  filter(r_calc_rounded == 0.2, n == 5) %>% 
  ggplot(aes(r_actual, p_posterior)) + 
  geom_line()
```


